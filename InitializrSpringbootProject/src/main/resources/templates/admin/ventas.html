<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <!-- Incluye el head con título personalizado -->
    <head th:replace="~{fragments/header :: head('Reporte de Ventas - KWestética')}">
        <!-- Este contenido será reemplazado por el fragmento head -->
    </head>
    
    <body class="admin-body">
        <div class="admin-container d-flex">
            <!-- Sidebar incluido desde otro template -->
            <div th:replace="~{fragments/admin-sidebar :: sidebar}"></div>
            
            <!-- Contenido Principal -->
            <div class="main-content flex-grow-1 lista-compacta-container" style="background-color: #f8f9fa; min-height: 100vh; padding: 15px;">
                <!-- Header -->
                <div class="lista-header-compacto">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold mb-1" style="color: var(--color-logo);">
                                <i class="bi bi-graph-up me-2"></i>Reporte de Ventas
                            </h1>
                            <p class="text-muted">Estadísticas y análisis de ventas del sistema</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="clearAllFilters()">
                                <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportSalesReport()">
                                <i class="bi bi-file-earmark-excel me-1"></i>Exportar Excel
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printReport()">
                                <i class="bi bi-printer me-1"></i>Imprimir
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros de fecha -->
                    <div class="row mt-3 g-2">
                        <div class="col-md-8">
                            <form method="get" action="/admin/ventas" class="d-flex gap-2 align-items-center" id="filterForm">
                                <div>
                                    <label class="form-label small mb-1 d-block">Filtrar por:</label>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="submit" name="periodo" value="today" 
                                                class="btn btn-outline-primary ${filtroPeriodo == 'today' ? 'active' : ''}">
                                            Hoy
                                        </button>
                                        <button type="submit" name="periodo" value="week" 
                                                class="btn btn-outline-primary ${filtroPeriodo == 'week' ? 'active' : ''}">
                                            Semana
                                        </button>
                                        <button type="submit" name="periodo" value="month" 
                                                class="btn btn-outline-primary ${filtroPeriodo == 'month' ? 'active' : ''}">
                                            Mes
                                        </button>
                                        <button type="submit" name="periodo" value="year" 
                                                class="btn btn-outline-primary ${filtroPeriodo == 'year' ? 'active' : ''}">
                                            Año
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="toggleCustomDateRange()">
                                            Personalizado
                                        </button>
                                    </div>
                                </div>
                                <div id="customDateRange" style="display: ${filtroFechaInicio != null or filtroFechaFin != null ? 'flex' : 'none'};">
                                    <div class="input-group input-group-sm" style="width: 400px;">
                                        <input type="date" class="form-control" id="startDate" name="fechaInicio" 
                                            th:value="${filtroFechaInicio}">
                                        <span class="input-group-text">al</span>
                                        <input type="date" class="form-control" id="endDate" name="fechaFin"
                                            th:value="${filtroFechaFin}">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearDateFilter()">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Campos ocultos para mantener otros filtros -->
                                <input type="hidden" id="estadoHidden" name="estado" th:value="${filtroEstado}">
                                <input type="hidden" id="metodoPagoHidden" name="metodoPago" th:value="${filtroMetodoPago}">
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Indicador de filtros aplicados -->
                <div th:if="${filtroEstado != null or filtroMetodoPago != null or filtroFechaInicio != null or filtroFechaFin != null}" 
                    class="alert alert-info py-2 mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small>
                            <i class="bi bi-funnel me-1"></i>
                            <strong>Filtros aplicados:</strong>
                            <span th:if="${filtroEstado != null}" class="badge bg-primary ms-2">
                                Estado: <span th:text="${filtroEstado}"></span>
                            </span>
                            <span th:if="${filtroMetodoPago != null}" class="badge bg-success ms-2">
                                Pago: <span th:text="${filtroMetodoPago}"></span>
                            </span>
                            <span th:if="${filtroPeriodo != null}" class="badge bg-info ms-2">
                                Período: <span th:text="${filtroPeriodo}"></span>
                            </span>
                            <span th:if="${filtroFechaInicio != null or filtroFechaFin != null}" class="badge bg-warning ms-2">
                                Fechas: 
                                <span th:if="${filtroFechaInicio != null}" 
                                    th:text="${#temporals.format(filtroFechaInicio, 'dd/MM/yyyy')}"></span>
                                <span th:if="${filtroFechaFin != null}"> 
                                    - <span th:text="${#temporals.format(filtroFechaFin, 'dd/MM/yyyy')}"></span>
                                </span>
                            </span>
                        </small>
                        <button class="btn btn-sm btn-outline-info" onclick="clearAllFilters()">
                            <i class="bi bi-x-lg me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Resumen de ventas -->
                <div class="row g-3 mb-4" style="margin-top: 15px;">
                    <div class="col-xl-3 col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body py-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="bi bi-cash-stack" style="color: var(--color-principal); font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" th:text="'$' + ${#numbers.formatDecimal(ingresosTotales, 1, 2)}">$0.00</h3>
                                        <p class="text-muted mb-0 small">Ingresos Totales</p>
                                        <small class="text-success" th:if="${ingresosTotales > 0}">
                                            <i class="bi bi-arrow-up me-1"></i>
                                            <span th:text="${#numbers.formatDecimal(ingresosTotales * 0.15, 1, 2)}">0</span> vs mes pasado
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body py-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="bi bi-receipt" style="color: #28a745; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" th:text="${ventas != null ? ventas.size() : 0}">0</h3>
                                        <p class="text-muted mb-0 small">Ventas Totales</p>
                                        <small class="text-success" th:if="${ventas != null && ventas.size() > 0}">
                                            <i class="bi bi-arrow-up me-1"></i>
                                            <span th:text="${ventas.size() * 0.1}">0</span> vs mes pasado
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body py-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="bi bi-check-circle" style="color: #17a2b8; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" th:text="${ventasCompletadas != null ? ventasCompletadas : 0}">0</h3>
                                        <p class="text-muted mb-0 small">Ventas Completadas</p>
                                        <small class="text-muted">
                                            Tasa de éxito: 
                                            <span th:if="${ventas != null && ventas.size() > 0}" 
                                                  th:text="${#numbers.formatDecimal((ventasCompletadas / ventas.size()) * 100, 1, 0)}">0</span>%
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body py-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="bi bi-credit-card" style="color: #ffc107; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-0" th:text="${ventasTarjeta != null ? ventasTarjeta : 0}">0</h3>
                                        <p class="text-muted mb-0 small">Ventas con Tarjeta</p>
                                        <small class="text-muted">
                                            <span th:if="${ventas != null && ventas.size() > 0}" 
                                                  th:text="${#numbers.formatDecimal((ventasTarjeta / ventas.size()) * 100, 1, 0)}">0</span>% del total
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0" style="color: var(--color-logo);">
                                    <i class="bi bi-bar-chart me-2"></i>Ventas por Mes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0" style="color: var(--color-logo);">
                                    <i class="bi bi-pie-chart me-2"></i>Métodos de Pago
                                </h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="paymentMethodChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between small">
                                        <div class="text-center">
                                            <span class="badge bg-primary me-1">■</span> 
                                            <div class="fw-semibold">Tarjeta</div>
                                            <div th:if="${ventasTarjeta > 0}" th:text="${metodosPagoPorcentajes.get('TARJETA')} + '%'">0%</div>
                                            <div class="text-muted" th:text="${ventasTarjeta} + ' ventas'">0 ventas</div>
                                        </div>
                                        <div class="text-center">
                                            <span class="badge bg-success me-1">■</span> 
                                            <div class="fw-semibold">Efectivo</div>
                                            <div th:if="${ventasEfectivo > 0}" th:text="${metodosPagoPorcentajes.get('EFECTIVO')} + '%'">0%</div>
                                            <div class="text-muted" th:text="${ventasEfectivo} + ' ventas'">0 ventas</div>
                                        </div>
                                        <div class="text-center">
                                            <span class="badge bg-info me-1">■</span> 
                                            <div class="fw-semibold">Transferencia</div>
                                            <div th:if="${ventasTransferencia > 0}" th:text="${metodosPagoPorcentajes.get('TRANSFERENCIA')} + '%'">0%</div>
                                            <div class="text-muted" th:text="${ventasTransferencia} + ' ventas'">0 ventas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top productos y tratamientos -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0" style="color: var(--color-logo);">
                                    <i class="bi bi-bag me-2"></i>Productos Más Vendidos
                                </h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${productosMasVendidos != null and !productosMasVendidos.isEmpty()}">
                                    <div th:each="producto, stat : ${productosMasVendidos}" class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-primary me-3" th:text="${stat.index + 1}"></span>
                                                <div>
                                                    <strong th:text="${producto.nombre}"></strong>
                                                    <div class="small text-muted">
                                                        Vendidos: <span th:text="${producto.cantidadVendida}"></span> unidades
                                                    </div>
                                                </div>
                                            </div>
                                            <span class="fw-bold" style="color: var(--color-principal);"
                                                  th:text="'$' + ${#numbers.formatDecimal(producto.totalVendido, 1, 2)}">
                                            </span>
                                        </div>
                                        <div class="progress mt-1" style="height: 5px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 th:style="'width: ' + ${producto.porcentaje} + '%;'"
                                                 th:attr="aria-valuenow=${producto.porcentaje}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${productosMasVendidos == null or productosMasVendidos.isEmpty()}" class="text-center py-4">
                                    <i class="bi bi-bag-x" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="text-muted mt-2 mb-0">No hay datos de productos vendidos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0" style="color: var(--color-logo);">
                                    <i class="bi bi-scissors me-2"></i>Tratamientos Más Solicitados
                                </h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${tratamientosMasSolicitados != null and !tratamientosMasSolicitados.isEmpty()}">
                                    <div th:each="tratamiento, stat : ${tratamientosMasSolicitados}" class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-primary me-3" th:text="${stat.index + 1}"></span>
                                                <div>
                                                    <strong th:text="${tratamiento.nombre}"></strong>
                                                    <div class="small text-muted">
                                                        Solicitudes: <span th:text="${tratamiento.cantidadSolicitada}"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <span class="fw-bold" style="color: var(--color-principal);"
                                                  th:text="'$' + ${#numbers.formatDecimal(tratamiento.ingresosGenerados, 1, 2)}">
                                            </span>
                                        </div>
                                        <div class="progress mt-1" style="height: 5px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 th:style="'width: ' + ${tratamiento.porcentaje} + '%;'"
                                                 th:attr="aria-valuenow=${tratamiento.porcentaje}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${tratamientosMasSolicitados == null or tratamientosMasSolicitados.isEmpty()}" class="text-center py-4">
                                    <i class="bi bi-scissors" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="text-muted mt-2 mb-0">No hay datos de tratamientos solicitados</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Historial de ventas -->
                <div class="tabla-compacta-container" style="margin-top: 25px;">
                    <div class="tabla-compacta-header d-flex justify-content-between align-items-center mb-3">
                        <h5 style="color: var(--color-logo); margin: 0;">
                            <i class="bi bi-clock-history me-2"></i>Historial de Ventas
                            <span class="badge bg-primary ms-2" th:text="${ventas != null ? ventas.size() : 0}"></span>
                        </h5>
                        <div class="d-flex gap-2">
                            <form method="get" action="/admin/ventas" class="d-flex gap-2" id="tableFilterForm">
                                <div class="input-group input-group-sm" style="width: 180px;">
                                    <span class="input-group-text">
                                        <i class="bi bi-filter"></i>
                                    </span>
                                    <select class="form-select form-select-sm" name="estado" onchange="this.form.submit()">
                                        <option value="">Todos los estados</option>
                                        <option value="COMPLETADA" th:selected="${filtroEstado == 'COMPLETADA'}">Completadas</option>
                                        <option value="PENDIENTE" th:selected="${filtroEstado == 'PENDIENTE'}">Pendientes</option>
                                        <option value="RECHAZADA" th:selected="${filtroEstado == 'RECHAZADA'}">Rechazadas</option>
                                    </select>
                                </div>
                                <div class="input-group input-group-sm" style="width: 180px;">
                                    <span class="input-group-text">
                                        <i class="bi bi-credit-card"></i>
                                    </span>
                                    <select class="form-select form-select-sm" name="metodoPago" onchange="this.form.submit()">
                                        <option value="">Todos los pagos</option>
                                        <option value="TARJETA" th:selected="${filtroMetodoPago == 'TARJETA'}">Tarjeta</option>
                                        <option value="EFECTIVO" th:selected="${filtroMetodoPago == 'EFECTIVO'}">Efectivo</option>
                                        <option value="TRANSFERENCIA" th:selected="${filtroMetodoPago == 'TRANSFERENCIA'}">Transferencia</option>
                                    </select>
                                </div>
                                
                                <!-- Campos ocultos para mantener otros filtros -->
                                <input type="hidden" name="periodo" th:value="${filtroPeriodo}">
                                <input type="hidden" name="fechaInicio" th:value="${filtroFechaInicio}">
                                <input type="hidden" name="fechaFin" th:value="${filtroFechaFin}">
                            </form>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover align-middle mb-0" id="salesTable">
                                    <thead style="background-color: var(--color-logo); color: white; position: sticky; top: 0; z-index: 1;">
                                        <tr>
                                            <th width="80">ID</th>
                                            <th>Cliente</th>
                                            <th width="150">Fecha</th>
                                            <th width="120">Total</th>
                                            <th width="140">Método de Pago</th>
                                            <th width="120">Estado</th>
                                            <th width="140" class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="venta : ${ventas}" class="sale-row"
                                            th:attr="data-status=${venta.estado.name()}, 
                                                    data-payment=${venta.metodoPago.name()}">
                                            <td>
                                                <span class="badge bg-dark" th:text="'#' + ${venta.id}"></span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-placeholder me-3">
                                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                             style="width: 40px; height: 40px; font-weight: bold; font-size: 14px;"
                                                             th:text="${#strings.substring(venta.usuario.nombre, 0, 1)} + ${#strings.substring(venta.usuario.apellido, 0, 1)}">
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <strong class="d-block" th:text="${venta.usuario.nombre} + ' ' + ${venta.usuario.apellido}"></strong>
                                                        <small class="text-muted" th:text="${venta.usuario.email}"></small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-medium">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        <span th:if="${venta.fechaVenta != null}" 
                                                            th:text="${#temporals.format(venta.fechaVenta, 'dd/MM/yyyy')}"></span>
                                                        <span th:if="${venta.fechaVenta == null}">--/--/----</span>
                                                    </span>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock me-1"></i>
                                                        <span th:if="${venta.fechaVenta != null}" 
                                                            th:text="${#temporals.format(venta.fechaVenta, 'HH:mm')}"></span>
                                                        <span th:if="${venta.fechaVenta == null}">--:--</span>
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-bold text-end" style="color: var(--color-principal);">
                                                    <span th:text="'$' + ${#numbers.formatDecimal(venta.total, 1, 2)}"></span>
                                                    <div class="progress mt-1" style="height: 4px;">
                                                        <div class="progress-bar bg-primary" 
                                                             th:style="'width: ' + ${(venta.total / ingresosTotales) * 100} + '%;'"
                                                             role="progressbar"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span th:if="${venta.metodoPago.name() == 'TARJETA'}" 
                                                      class="badge bg-primary d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-credit-card"></i> Tarjeta
                                                </span>
                                                <span th:if="${venta.metodoPago.name() == 'EFECTIVO'}" 
                                                      class="badge bg-success d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-cash"></i> Efectivo
                                                </span>
                                                <span th:if="${venta.metodoPago.name() == 'TRANSFERENCIA'}" 
                                                      class="badge bg-info d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-bank"></i> Transferencia
                                                </span>
                                            </td>
                                            <td>
                                                <span th:if="${venta.estado.name() == 'PENDIENTE'}" 
                                                      class="badge bg-warning text-dark d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-clock"></i> Pendiente
                                                </span>
                                                <span th:if="${venta.estado.name() == 'COMPLETADA'}" 
                                                      class="badge bg-success d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-check-circle"></i> Completada
                                                </span>
                                                <span th:if="${venta.estado.name() == 'RECHAZADA'}" 
                                                      class="badge bg-danger d-flex align-items-center justify-content-center gap-1 py-2"
                                                      style="width: 110px;">
                                                    <i class="bi bi-x-circle"></i> Rechazada
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-center gap-2">
                                                    <button class="btn btn-sm btn-outline-info btn-action" 
                                                            th:onclick="'viewSaleDetails(' + ${venta.id} + ')'"
                                                            title="Ver detalles">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button th:if="${venta.estado.name() == 'PENDIENTE'}"
                                                            class="btn btn-sm btn-outline-success btn-action"
                                                            th:onclick="'updateSaleStatus(' + ${venta.id} + ', \"COMPLETADA\")'"
                                                            title="Marcar como completada">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    <button th:if="${venta.estado.name() == 'PENDIENTE'}"
                                                            class="btn btn-sm btn-outline-danger btn-action"
                                                            th:onclick="'updateSaleStatus(' + ${venta.id} + ', \"RECHAZADA\")'"
                                                            title="Marcar como rechazada">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                    <button th:if="${venta.estado.name() != 'PENDIENTE'}"
                                                            class="btn btn-sm btn-outline-secondary btn-action disabled"
                                                            style="opacity: 0.5; cursor: not-allowed;"
                                                            title="Acciones no disponibles">
                                                        <i class="bi bi-lock"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        
                                        <!-- Mensaje si no hay ventas -->
                                        <tr th:if="${ventas == null or ventas.isEmpty()}">
                                            <td colspan="7" class="text-center py-5">
                                                <div class="empty-state">
                                                    <i class="bi bi-receipt" style="font-size: 4rem; color: #6c757d; opacity: 0.5;"></i>
                                                    <h5 class="mt-3" style="color: var(--color-logo);">No hay ventas registradas</h5>
                                                    <p class="text-muted mb-4">Las ventas aparecerán aquí una vez que se realicen transacciones.</p>
                                                    <a th:href="@{/carrito}" class="btn btn-primary">
                                                        <i class="bi bi-cart-plus me-2"></i>Ir al carrito
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Información de resultados -->
                            <div th:if="${ventas != null and !ventas.isEmpty()}" class="d-flex justify-content-between align-items-center p-3 border-top">
                                <div class="text-muted small">
                                    Mostrando <span th:text="${ventas.size()}"></span> 
                                    <span th:text="${ventas.size() == 1 ? 'venta' : 'ventas'}"></span>
                                    <span class="ms-2">
                                        <i class="bi bi-cash-stack me-1"></i>
                                        Total: <span class="fw-bold" th:text="'$' + ${#numbers.formatDecimal(ingresosTotales, 1, 2)}"></span>
                                    </span>
                                </div>
                                <div class="text-muted small">
                                    <span th:if="${ventasCompletadas != null and ventasCompletadas > 0}">
                                        <i class="bi bi-check-circle text-success me-1"></i>
                                        <span th:text="${ventasCompletadas}"></span> completadas
                                    </span>
                                    <span th:if="${ventasTarjeta != null and ventasTarjeta > 0}" class="ms-3">
                                        <i class="bi bi-credit-card text-primary me-1"></i>
                                        <span th:text="${ventasTarjeta}"></span> con tarjeta
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Incluye Chart.js y scripts generales -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- Script específico para reportes de ventas -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // Inicializar tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Inicializar gráficos
                initializeCharts();
                
                // Establecer fechas por defecto
                const today = new Date();
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (startDateInput && endDateInput) {
                    startDateInput.value = today.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                }
                
                // Añadir efectos hover a las filas
                const rows = document.querySelectorAll('.sale-row');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = 'rgba(196, 105, 110, 0.05)';
                        this.style.transition = 'background-color 0.2s ease';
                    });
                    row.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                    });
                });
            });

            // Función para alternar el rango de fechas personalizado
            function toggleCustomDateRange() {
                const customRange = document.getElementById('customDateRange');
                if (customRange.style.display === 'none' || customRange.style.display === '') {
                    customRange.style.display = 'flex';
                    
                    // Si no hay fechas establecidas, establecer la fecha de hoy
                    const startDate = document.getElementById('startDate');
                    const endDate = document.getElementById('endDate');
                    
                    if (!startDate.value) {
                        const today = new Date();
                        startDate.value = today.toISOString().split('T')[0];
                    }
                    
                    if (!endDate.value) {
                        const today = new Date();
                        endDate.value = today.toISOString().split('T')[0];
                    }
                } else {
                    customRange.style.display = 'none';
                }
            }

            // Función para limpiar filtro de fechas
            function clearDateFilter() {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                
                // Enviar formulario sin fechas
                document.getElementById('filterForm').submit();
            }

            // Función para aplicar filtros de tabla (ya no se usa, se envía el formulario directamente)
            function filterSales() {
                // Esta función ya no es necesaria porque los filtros se envían directamente
                // Mantenemos la función para evitar errores, pero puede estar vacía
            }

            // Función para setear filtro de fecha (modificada para usar formulario)
            function setDateFilter(range) {
                // Establecer el valor del periodo en el formulario
                const periodoInput = document.querySelector('input[name="periodo"]');
                if (periodoInput) {
                    periodoInput.value = range;
                }
                
                // Limpiar fechas personalizadas si se selecciona un periodo predefinido
                if (range !== 'custom') {
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    document.getElementById('customDateRange').style.display = 'none';
                }
                
                // Actualizar los botones activos
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.value === range) {
                        btn.classList.add('active');
                    }
                });
                
                // Enviar formulario
                document.getElementById('filterForm').submit();
            }

            // Función para aplicar fechas personalizadas (modificada)
            function applyCustomDate() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    // Establecer el periodo como custom
                    const periodoInput = document.querySelector('input[name="periodo"]');
                    if (periodoInput) {
                        periodoInput.value = 'custom';
                    }
                    
                    // Enviar formulario
                    document.getElementById('filterForm').submit();
                } else {
                    showToast('Debes seleccionar ambas fechas', 'warning');
                }
            }

            // Inicializar botones activos al cargar la página
            document.addEventListener('DOMContentLoaded', function() {
                // Establecer botón activo según el periodo actual
                const periodoActual = '[[${filtroPeriodo}]]' || '';
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    if (btn.value === periodoActual) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Si hay fechas personalizadas, mostrar el selector
                const fechaInicio = '[[${filtroFechaInicio}]]';
                const fechaFin = '[[${filtroFechaFin}]]';
                
                if (fechaInicio || fechaFin) {
                    const customRange = document.getElementById('customDateRange');
                    if (customRange) {
                        customRange.style.display = 'flex';
                    }
                }
            });
            
            function initializeCharts() {
                // Gráfico de ventas por mes con datos reales
                const salesCtx = document.getElementById('salesChart').getContext('2d');
                const salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                        datasets: [{
                            label: 'Ventas ($)',
                            data: [
                                /*[[${ventasPorMes[0]}]]*/ 0,
                                /*[[${ventasPorMes[1]}]]*/ 0,
                                /*[[${ventasPorMes[2]}]]*/ 0,
                                /*[[${ventasPorMes[3]}]]*/ 0,
                                /*[[${ventasPorMes[4]}]]*/ 0,
                                /*[[${ventasPorMes[5]}]]*/ 0,
                                /*[[${ventasPorMes[6]}]]*/ 0,
                                /*[[${ventasPorMes[7]}]]*/ 0,
                                /*[[${ventasPorMes[8]}]]*/ 0,
                                /*[[${ventasPorMes[9]}]]*/ 0,
                                /*[[${ventasPorMes[10]}]]*/ 0,
                                /*[[${ventasPorMes[11]}]]*/ 0
                            ],
                            borderColor: 'rgba(196, 105, 110, 1)',
                            backgroundColor: 'rgba(196, 105, 110, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(82, 49, 76, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString('es-MX');
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: 'rgba(82, 49, 76, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(196, 105, 110, 1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const month = context.label;
                                        
                                        // Obtener el porcentaje del total anual
                                        const totalAnual = /*[[${totalVentasAnual}]]*/ 0;
                                        const porcentaje = totalAnual > 0 ? ((value / totalAnual) * 100).toFixed(1) : 0;
                                        
                                        return `${month}: $${value.toLocaleString('es-MX')} (${porcentaje}% del total anual)`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Gráfico de métodos de pago con datos reales
                const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
                const paymentChart = new Chart(paymentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Tarjeta', 'Efectivo', 'Transferencia'],
                        datasets: [{
                            data: [
                                /*[[${ventasTarjeta}]]*/ 0,
                                /*[[${ventasEfectivo}]]*/ 0,
                                /*[[${ventasTransferencia}]]*/ 0
                            ],
                            backgroundColor: [
                                'rgba(82, 49, 76, 0.9)',
                                'rgba(196, 105, 110, 0.9)',
                                'rgba(157, 107, 108, 0.9)'
                            ],
                            borderColor: [
                                'rgba(82, 49, 76, 1)',
                                'rgba(196, 105, 110, 1)',
                                'rgba(157, 107, 108, 1)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(82, 49, 76, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        
                                        // Obtener los datos reales del modelo
                                        const ventasTarjeta = /*[[${ventasTarjeta}]]*/ 0;
                                        const ventasEfectivo = /*[[${ventasEfectivo}]]*/ 0;
                                        const ventasTransferencia = /*[[${ventasTransferencia}]]*/ 0;
                                        
                                        // Determinar cuál método estamos mostrando
                                        let ventasMetodo = 0;
                                        if (label === 'Tarjeta') ventasMetodo = ventasTarjeta;
                                        else if (label === 'Efectivo') ventasMetodo = ventasEfectivo;
                                        else if (label === 'Transferencia') ventasMetodo = ventasTransferencia;
                                        
                                        return `${label}: ${ventasMetodo} ventas (${percentage}% del total)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            function clearAllFilters() {
                // Redirigir sin parámetros de filtro
                window.location.href = '/admin/ventas';
            }
            function setDateFilter(range) {
                // Activar botón correspondiente
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Mostrar/ocultar selector de fechas personalizadas
                const customRange = document.getElementById('customDateRange');
                if (range === 'custom') {
                    customRange.style.display = 'flex';
                    customRange.style.alignItems = 'center';
                } else {
                    customRange.style.display = 'none';
                    // Aquí implementarías la lógica para filtrar por el rango seleccionado
                    console.log('Filtrar por:', range);
                }
            }
            
            function applyCustomDate() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    console.log('Filtrar desde', startDate, 'hasta', endDate);
                    // Aquí implementarías la lógica para filtrar las ventas por fecha
                    showToast(`Filtrando desde ${startDate} hasta ${endDate}`, 'info');
                }
            }
            
            function filterSales() {
                const statusFilter = document.getElementById('statusFilter').value;
                const paymentFilter = document.getElementById('paymentFilter').value;
                const rows = document.querySelectorAll('.sale-row');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const status = row.getAttribute('data-status');
                    const payment = row.getAttribute('data-payment');
                    
                    const matchesStatus = !statusFilter || status === statusFilter;
                    const matchesPayment = !paymentFilter || payment === paymentFilter;
                    
                    if (matchesStatus && matchesPayment) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Actualizar contador en el header
                const badge = document.querySelector('.tabla-compacta-header .badge');
                if (badge) {
                    badge.textContent = visibleCount;
                }
                
                showToast(`Mostrando ${visibleCount} ventas`, 'info');
            }
            
            function viewSaleDetails(saleId) {
                // Redirigir a vista de detalles de venta
                window.location.href = `/admin/ventas/${saleId}`;
            }
            
            function updateSaleStatus(saleId, status) {
                const statusText = status === 'COMPLETADA' ? 'completada' : 'rechazada';
                const icon = status === 'COMPLETADA' ? '✅' : '❌';
                
                if (confirm(`${icon} ¿Está seguro de marcar la venta #${saleId} como ${statusText}?`)) {
                    fetch(`/admin/ventas/${saleId}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': getCsrfToken()
                        },
                        body: JSON.stringify({ estado: status })
                    }).then(response => {
                        if (response.ok) {
                            showToast(`✅ Venta #${saleId} marcada como ${statusText}`, 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showToast('❌ Error al actualizar estado', 'danger');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        showToast('❌ Error de conexión', 'danger');
                    });
                }
            }
            
            function exportSalesReport() {
                // Implementar exportación a Excel
                showToast('📊 Generando reporte Excel...', 'info');
                setTimeout(() => {
                    showToast('✅ Reporte Excel generado correctamente', 'success');
                }, 2000);
                // window.location.href = '/admin/ventas/exportar/excel';
            }
            
            function printReport() {
                showToast('🖨️ Preparando para imprimir...', 'info');
                setTimeout(() => {
                    window.print();
                }, 500);
            }
            
            function showToast(message, type = 'info') {
                // Eliminar toast existentes
                document.querySelectorAll('.custom-toast').forEach(toast => toast.remove());
                
                const toast = document.createElement('div');
                toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
                toast.style.cssText = `
                    top: 20px; 
                    right: 20px; 
                    z-index: 9999; 
                    min-width: 300px; 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    border-left: 4px solid ${type === 'success' ? '#28a745' : type === 'danger' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                `;
                toast.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-triangle' : type === 'warning' ? 'bi-exclamation-circle' : 'bi-info-circle'} me-2" 
                           style="font-size: 1.2rem;"></i>
                        <div style="flex: 1;">${message}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            function getCsrfToken() {
                const metaTag = document.querySelector('meta[name="_csrf"]');
                return metaTag ? metaTag.getAttribute('content') : '';
            }
        </script>
        
        <!-- Estilos adicionales para mejorar la apariencia -->
        <style>
            .btn-action {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                transition: all 0.2s ease;
            }
            
            .btn-action:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            
            .avatar-placeholder {
                flex-shrink: 0;
            }
            
            .empty-state {
                padding: 3rem 1rem;
            }
            
            .table th {
                font-weight: 600;
                font-size: 0.85rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                padding: 1rem 0.75rem;
            }
            
            .table td {
                padding: 1rem 0.75rem;
                vertical-align: middle;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            
            .table tbody tr:last-child td {
                border-bottom: none;
            }
            
            .badge {
                font-weight: 500;
                letter-spacing: 0.3px;
            }
            
            .custom-toast {
                animation: slideInRight 0.3s ease;
            }
            
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .progress {
                background-color: rgba(0,0,0,0.05);
                border-radius: 10px;
            }
            
            .progress-bar {
                border-radius: 10px;
            }
        </style>
    </body>
</html>