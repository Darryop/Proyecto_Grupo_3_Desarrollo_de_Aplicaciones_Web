<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments/header :: head}">
        <title>Mis Citas | KWestética</title>
    </th:block>
</head>
<body>
    <th:block th:insert="~{fragments/header :: body}">
        <div class="container py-5">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h1 style="color: var(--color-logo);">Mis Citas</h1>
                    <p class="text-muted">Gestiona tus citas programadas en KWestética.</p>
                </div>
                <div class="col-md-4 text-end">
                    <a th:href="@{/citas/nueva}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Cita
                    </a>
                </div>
            </div>

            <!-- Lista de citas -->
            <div class="row">
                <div class="col-12">
                    <div th:if="${citas != null and !citas.isEmpty()}">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tratamiento</th>
                                        <th>Fecha y Hora</th>
                                        <th>Estado</th>
                                        <th>Notas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="cita : ${citas}">
                                        <td th:text="${cita.tratamiento.nombre}"></td>
                                        <td th:text="${#dates.format(cita.fechaCita, 'dd/MM/yyyy HH:mm')}"></td>
                                        <td>
                                            <span th:switch="${cita.estado}">
                                                <span th:case="'PENDIENTE'" class="badge bg-warning">Pendiente</span>
                                                <span th:case="'CONFIRMADA'" class="badge bg-success">Confirmada</span>
                                                <span th:case="'COMPLETADA'" class="badge bg-info">Completada</span>
                                                <span th:case="'CANCELADA'" class="badge bg-danger">Cancelada</span>
                                            </span>
                                        </td>
                                        <td>
                                            <span th:if="${cita.notas != null and cita.notas != ''}" th:text="${#strings.abbreviate(cita.notas, 50)}"></span>
                                            <span th:unless="${cita.notas != null and cita.notas != ''}" class="text-muted">Sin notas</span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button th:if="${cita.estado.name() == 'PENDIENTE' or cita.estado.name() == 'CONFIRMADA'}"
                                                        class="btn btn-danger btn-sm"
                                                        th:onclick="'cancelarCita(' + ${cita.id} + ')'">
                                                    <i class="bi bi-x-circle"></i> Cancelar
                                                </button>
                                                <a th:href="@{/carrito/agregar/cita/{id}(id=${cita.id})}" 
                                                   th:if="${cita.estado.name() == 'CONFIRMADA'}"
                                                   class="btn btn-primary btn-sm">
                                                    <i class="bi bi-cart-plus"></i> Pagar
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div th:if="${citas == null or citas.isEmpty()}" class="text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 4rem; color: var(--color-details);"></i>
                        <h3 class="mt-3" style="color: var(--color-logo);">No tienes citas programadas</h3>
                        <p class="text-muted">¡Agenda tu primera cita y descubre nuestros servicios!</p>
                        <a th:href="@{/citas/nueva}" class="btn btn-primary mt-3">
                            <i class="bi bi-calendar-plus"></i> Agendar Mi Primera Cita
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function cancelarCita(citaId) {
                if (confirm('¿Estás seguro de cancelar esta cita?')) {
                    fetch(`/citas/cancelar/${citaId}`, {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            alert('Cita cancelada correctamente');
                            location.reload();
                        } else {
                            alert('Error al cancelar la cita');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                    });
                }
            }
        </script>
    </th:block>
</body>
</html>