<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layouts/layout}">
<head>
    <title>Carrito de Compras - KVestética</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"><!-- comment -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <h1 class="mb-4">
                <i class="fas fa-shopping-cart me-2 text-color1"></i>Mi Carrito de Compras
            </h1>

            <div th:if="${items.empty}">
                <div class="alert alert-info text-center py-5">
                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                    <h3 class="text-color2">Tu carrito está vacío</h3>
                    <p class="lead text-muted mb-4">Explora nuestros productos y tratamientos para agregar items a tu carrito.</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a th:href="@{/productos}" class="btn btn-primary btn-lg">
                            <i class="fas fa-shopping-bag me-2"></i>Ver Productos
                        </a>
                        <a th:href="@{/tratamientos}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-spa me-2"></i>Ver Tratamientos
                        </a>
                    </div>
                </div>
            </div>

            <div th:unless="${items.empty}">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Items del Carrito -->
                        <div class="card mb-4">
                            <div class="card-header bg-color2 text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Items en el Carrito
                                    <span class="badge bg-color3 ms-2" th:text="${items.size()}"></span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div th:each="item : ${items}" class="cart-item mb-4 pb-4 border-bottom">
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <div th:if="${item.tipo.name() == 'PRODUCTO'}">
                                                <img th:src="${item.producto.imagenUrl}" 
                                                     class="img-fluid rounded shadow-sm" 
                                                     style="height: 80px; width: 80px; object-fit: cover;"
                                                     onerror="this.src='https://via.placeholder.com/80?text=Producto'">
                                            </div>
                                            <div th:if="${item.tipo.name() == 'CITA'}" 
                                                 class="text-center text-color1">
                                                <i class="fas fa-calendar-alt fa-3x"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <h6 class="fw-bold text-color2" 
                                                th:text="${item.tipo.name() == 'PRODUCTO'} ? ${item.producto.nombre} : ${item.cita.tratamiento.nombre}">
                                            </h6>
                                            <small class="text-muted" 
                                                   th:text="${item.tipo.name() == 'PRODUCTO'} ? ${item.producto.descripcion} : 'Cita programada'">
                                            </small>
                                            <div th:if="${item.tipo.name() == 'CITA'}" class="mt-1">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <span th:text="${#temporals.format(item.cita.fechaCita, 'dd/MM/yyyy HH:mm')}"></span>
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-2">
                                            <span class="h6 text-color1 mb-0" 
                                                  th:text="'$' + ${#numbers.formatDecimal(item.precioUnitario, 1, 2)}">
                                            </span>
                                        </div>
                                        
                                        <div class="col-md-2">
                                            <div th:if="${item.tipo.name() == 'PRODUCTO'}" 
                                                 class="quantity-controls input-group input-group-sm" style="width: 120px;">
                                                <button class="btn btn-outline-secondary" 
                                                        th:onclick="|decrementarCantidad(${item.id})|"
                                                        th:disabled="${item.cantidad <= 1}">-</button>
                                                <input type="number" class="form-control text-center" 
                                                       th:value="${item.cantidad}" min="1" 
                                                       th:onchange="|actualizarCantidad(${item.id}, this.value)|">
                                                <button class="btn btn-outline-secondary" 
                                                        th:onclick="|incrementarCantidad(${item.id})|">+</button>
                                            </div>
                                            <div th:if="${item.tipo.name() == 'CITA'}" class="text-center">
                                                <span class="badge bg-color4">1 Sesión</span>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-2 text-end">
                                            <strong class="h6 text-color2" 
                                                    th:text="'$' + ${#numbers.formatDecimal(item.precioUnitario * item.cantidad, 1, 2)}">
                                            </strong>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-2">
                                        <div class="col text-end">
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    th:onclick="|eliminarItem(${item.id})|">
                                                <i class="fas fa-trash me-1"></i>Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Resumen del Pedido -->
                        <div class="card cart-total sticky-top" style="top: 20px;">
                            <div class="card-header bg-color4 text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-receipt me-2"></i>Resumen del Pedido
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span th:text="'$' + ${#numbers.formatDecimal(total, 1, 2)}"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Envío:</span>
                                    <span>Gratis</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 border-top pt-2">
                                    <strong>Total:</strong>
                                    <strong class="h5 text-color1" 
                                            th:text="'$' + ${#numbers.formatDecimal(total, 1, 2)}">
                                    </strong>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a th:href="@{/ventas/procesar}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-credit-card me-2"></i>Proceder al Pago
                                    </a>
                                    <button class="btn btn-outline-danger" th:onclick="vaciarCarrito()">
                                        <i class="fas fa-trash me-2"></i>Vaciar Carrito
                                    </button>
                                    <a th:href="@{/productos}" class="btn btn-outline-secondary">
                                        <i class="fas fa-shopping-bag me-2"></i>Seguir Comprando
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            function actualizarCantidad(itemId, nuevaCantidad) {
                if (nuevaCantidad < 1) {
                    nuevaCantidad = 1;
                }
                
                fetch('/carrito/actualizar/' + itemId + '?cantidad=' + nuevaCantidad, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error al actualizar la cantidad');
                    }
                });
            }

            function incrementarCantidad(itemId) {
                const input = document.querySelector('input[onchange*="' + itemId + '"]');
                if (input) {
                    let nuevaCantidad = parseInt(input.value) + 1;
                    actualizarCantidad(itemId, nuevaCantidad);
                }
            }

            function decrementarCantidad(itemId) {
                const input = document.querySelector('input[onchange*="' + itemId + '"]');
                if (input) {
                    let nuevaCantidad = parseInt(input.value) - 1;
                    if (nuevaCantidad < 1) nuevaCantidad = 1;
                    actualizarCantidad(itemId, nuevaCantidad);
                }
            }

            function eliminarItem(itemId) {
                if (confirm('¿Estás seguro de que quieres eliminar este item del carrito?')) {
                    fetch('/carrito/eliminar/' + itemId, {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error al eliminar el item');
                        }
                    });
                }
            }

            function vaciarCarrito() {
                if (confirm('¿Estás seguro de que quieres vaciar todo el carrito?')) {
                    fetch('/carrito/vaciar', {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error al vaciar el carrito');
                        }
                    });
                }
            }
        </script>
    </div>
</body>
</html>